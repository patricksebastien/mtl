#N canvas 0 98 1920 982 10;
#X obj 839 85 *;
#X obj 857 61 r \$0-samplelength;
#X obj 839 37 r \$0-pos;
#X obj 839 110 s \$0-newpos;
#X obj 839 240 *;
#X obj 858 187 r \$0-samplelength;
#X obj 839 139 r \$0-duration;
#X obj 839 268 s \$0-durational;
#X obj 839 162 expr pow($f1 \, 2);
#X obj 839 212 t b f;
#X obj 673 464 / 100;
#X obj 673 442 r \$0-pitchpercent;
#X obj 673 485 s \$0-pitch;
#N canvas 365 98 862 695 fft 0;
#X obj 33 499 *~;
#X obj 210 501 *~;
#X obj 59 13 bang~;
#X obj 83 141 +;
#X obj 43 117 t f f;
#X msg 35 215 \$1 \, \$2 \$3;
#X obj 69 289 / 4;
#X obj 240 145 *;
#X obj 264 91 t b f;
#X obj 93 91 / 2;
#X obj 56 91 -;
#X text 129 88 back up 1/2 window;
#X obj 34 289 -~;
#X text 123 274 "back" window 1/4 cycle behind "front" one;
#X obj 203 243 / 176.4;
#X obj 39 182 pack 0 0 11.61;
#X text 269 145 stretched window size (samples);
#X obj 263 64 r \$0-window-size;
#X obj 203 219 r \$0-window-size;
#X obj 685 251 block~;
#X msg 685 226 set \$1 4;
#X text 659 162 'set' message to block;
#X text 665 177 allows variable size;
#X obj 685 203 r \$0-window-size;
#N canvas 77 98 955 708 fft-analysis 0;
#X obj 51 477 *~;
#X obj 18 477 *~;
#X obj 18 499 -~;
#X obj 167 475 *~;
#X obj 136 475 *~;
#X obj 136 497 +~;
#X obj 109 193 *~;
#X obj 78 193 *~;
#X obj 50 193 *~;
#X obj 19 193 *~;
#X obj 19 218 +~;
#X obj 127 379 *~;
#X obj 64 661 *~;
#X obj 238 430 rfft~;
#X obj 108 161 rfft~;
#X obj 19 564 rifft~;
#X obj 65 685 outlet~;
#X obj 97 379 *~;
#X obj 97 401 +~;
#X obj 124 218 -~;
#X obj 18 431 *~;
#X obj 51 432 *~;
#X obj 19 349 +~ 1e-15;
#X obj 19 598 *~;
#X obj 135 639 expr 2/(3*$f1);
#X obj 97 425 q8_rsqrt~;
#X text 307 31 recall previous output amplitude. Its phase will be
added to the phase difference we measure from two windows in the the
recorded sound.;
#X obj 121 69 *~;
#X obj 89 69 *~;
#X obj 89 91 +~;
#X obj 159 94 q8_rsqrt~;
#X obj 159 71 +~ 1e-20;
#X obj 73 119 *~;
#X obj 19 118 *~;
#X obj 29 245 lrshift~ 1;
#X obj 24 269 lrshift~ -1;
#X obj 141 245 lrshift~ 1;
#X obj 133 269 lrshift~ -1;
#X obj 35 300 *~;
#X obj 159 312 *~;
#X obj 19 325 +~;
#X obj 125 331 +~;
#X text 282 92 divide by the magnitude to make a unit-magnitude complex
amplitude (phase only). The 1e-20 is to prevent overflows. q8_rsqrt~
is reciprocal square root.;
#X text 282 191 Take FT of the window in back. Multiply its conjugate
by the normalized previous output. The result has the magnitude of
the input sound and phase (previous output phase) minus (back window
phase).;
#X text 284 396 Normalize again \, this time taking care to salt each
channel with 1e-15 so that we get a unit complex number even if everything
was zero heretofore.;
#X text 323 453 Now take the FT of the forward window and multiply
it by the unit complex number from above. The magnitude will be that
of the forward window and the phase will be the previous output phase
plus the phase difference between the two analysis windows -- except
that if "lock" is on \, they will be modified to agree progressively
better with the inter-channel phase relationships of the input.;
#X text 284 268 If "lock" is on \, encourage neighboring channels to
stay in phase by adding the two neighboring complex amplitudes. The
result will tend toward the channel with the strongest amplitude. If
the phase relationships between channels in the output and those in
the input are in parallel \, then neighboring channels of the quotient
will all have the same phase and this will not change any phases. (lrshift
shifts the signal to the left or right depending on its argument.)
;
#X text 294 152 Read two windows \, one 1/4 length behind the other
\, of the input sound \, with Hann window function (see inside).;
#X obj 134 541 tabsend~ \$0-prev-imag;
#X obj 136 567 tabsend~ \$0-prev-real;
#X obj 20 8 tabreceive~ \$0-prev-real;
#X obj 73 29 tabreceive~ \$0-prev-imag;
#X obj 133 618 r \$0-window-size;
#X obj 109 133 inlet~;
#X obj 238 398 inlet~;
#X obj 210 310 sig~;
#X obj 209 284 r \$0-lock;
#X obj 71 590 tabreceive~ \$0-hann;
#X connect 0 0 2 1;
#X connect 1 0 2 0;
#X connect 2 0 15 0;
#X connect 2 0 49 0;
#X connect 3 0 5 1;
#X connect 4 0 5 0;
#X connect 5 0 15 1;
#X connect 5 0 48 0;
#X connect 6 0 19 1;
#X connect 7 0 19 0;
#X connect 8 0 10 1;
#X connect 9 0 10 0;
#X connect 10 0 35 0;
#X connect 10 0 34 0;
#X connect 10 0 40 0;
#X connect 11 0 18 1;
#X connect 12 0 16 0;
#X connect 13 0 1 1;
#X connect 13 0 3 1;
#X connect 13 1 0 1;
#X connect 13 1 4 1;
#X connect 14 0 9 1;
#X connect 14 0 7 1;
#X connect 14 1 6 1;
#X connect 14 1 8 1;
#X connect 15 0 23 0;
#X connect 17 0 18 0;
#X connect 18 0 25 0;
#X connect 19 0 36 0;
#X connect 19 0 37 0;
#X connect 19 0 41 0;
#X connect 20 0 1 0;
#X connect 20 0 4 0;
#X connect 21 0 0 0;
#X connect 21 0 3 0;
#X connect 22 0 17 1;
#X connect 22 0 17 0;
#X connect 22 0 20 0;
#X connect 23 0 12 0;
#X connect 24 0 12 1;
#X connect 25 0 20 1;
#X connect 25 0 21 1;
#X connect 27 0 29 1;
#X connect 28 0 29 0;
#X connect 29 0 31 0;
#X connect 30 0 32 1;
#X connect 30 0 33 1;
#X connect 31 0 30 0;
#X connect 32 0 8 0;
#X connect 32 0 7 0;
#X connect 33 0 9 0;
#X connect 33 0 6 0;
#X connect 34 0 38 0;
#X connect 35 0 38 0;
#X connect 36 0 39 0;
#X connect 37 0 39 0;
#X connect 38 0 40 1;
#X connect 39 0 41 1;
#X connect 40 0 22 0;
#X connect 41 0 11 0;
#X connect 41 0 11 1;
#X connect 41 0 21 0;
#X connect 50 0 28 1;
#X connect 50 0 28 0;
#X connect 50 0 33 0;
#X connect 51 0 27 1;
#X connect 51 0 27 0;
#X connect 51 0 32 0;
#X connect 52 0 24 0;
#X connect 53 0 14 0;
#X connect 54 0 13 0;
#X connect 55 0 39 1;
#X connect 55 0 38 1;
#X connect 56 0 55 0;
#X connect 57 0 23 1;
#X restore 33 535 pd fft-analysis;
#X obj 34 560 outlet~;
#X obj 656 114 s \$0-window-size;
#X obj 40 245 vline~;
#X obj 545 296 r \$0-window-size;
#X obj 545 341 t f f;
#X msg 614 371 resize \$1;
#X obj 615 396 s \$0-hann;
#X obj 448 111 table \$0-hann 256;
#X obj 546 422 f;
#X obj 573 424 + 1;
#X obj 546 400 until;
#X msg 584 394 0;
#X obj 546 446 t f f;
#X obj 573 474 /;
#X obj 546 368 t f b f;
#X obj 575 532 * 3.14159;
#X obj 574 553 cos;
#X obj 546 620 pack;
#X obj 546 640 s \$0-hann;
#X obj 574 513 * 2;
#X obj 573 493 + 0.5;
#X obj 575 573 + 1;
#X obj 574 597 * 0.5;
#X obj 656 90 expr pow(2 \, $f1)*256;
#X obj 59 67 snapshot~;
#X obj 100 16 inlet~;
#X obj 32 326 tabread4~ \$0-sampleL;
#X obj 212 329 tabread4~ \$0-sampleL;
#X obj 235 14 r \$0-pitch;
#X obj 656 66 r \$0-window_size;
#X obj 50 410 tabreceive~ \$0-hann;
#X obj 545 318 change;
#X obj 447 21 table \$0-prev-real 4096;
#X obj 447 44 table \$0-prev-imag 4096;
#X obj 65 359 tabread4~ \$0-sampleR;
#X obj 246 361 tabread4~ \$0-sampleR;
#X obj 447 66 table \$0-prev-realb 4096;
#X obj 447 89 table \$0-prev-imagb 4096;
#N canvas 77 50 955 708 fft-analysis 0;
#X obj 51 477 *~;
#X obj 18 477 *~;
#X obj 18 499 -~;
#X obj 167 475 *~;
#X obj 136 475 *~;
#X obj 136 497 +~;
#X obj 109 193 *~;
#X obj 78 193 *~;
#X obj 50 193 *~;
#X obj 19 193 *~;
#X obj 19 218 +~;
#X obj 127 379 *~;
#X obj 64 661 *~;
#X obj 238 430 rfft~;
#X obj 108 161 rfft~;
#X obj 19 564 rifft~;
#X obj 65 685 outlet~;
#X obj 97 379 *~;
#X obj 97 401 +~;
#X obj 124 218 -~;
#X obj 18 431 *~;
#X obj 51 432 *~;
#X obj 19 349 +~ 1e-15;
#X obj 19 598 *~;
#X obj 135 639 expr 2/(3*$f1);
#X obj 97 425 q8_rsqrt~;
#X text 307 31 recall previous output amplitude. Its phase will be
added to the phase difference we measure from two windows in the the
recorded sound.;
#X obj 121 69 *~;
#X obj 89 69 *~;
#X obj 89 91 +~;
#X obj 159 94 q8_rsqrt~;
#X obj 159 71 +~ 1e-20;
#X obj 73 119 *~;
#X obj 19 118 *~;
#X obj 29 245 lrshift~ 1;
#X obj 24 269 lrshift~ -1;
#X obj 141 245 lrshift~ 1;
#X obj 133 269 lrshift~ -1;
#X obj 35 300 *~;
#X obj 159 312 *~;
#X obj 19 325 +~;
#X obj 125 331 +~;
#X text 282 92 divide by the magnitude to make a unit-magnitude complex
amplitude (phase only). The 1e-20 is to prevent overflows. q8_rsqrt~
is reciprocal square root.;
#X text 282 191 Take FT of the window in back. Multiply its conjugate
by the normalized previous output. The result has the magnitude of
the input sound and phase (previous output phase) minus (back window
phase).;
#X text 284 396 Normalize again \, this time taking care to salt each
channel with 1e-15 so that we get a unit complex number even if everything
was zero heretofore.;
#X text 323 453 Now take the FT of the forward window and multiply
it by the unit complex number from above. The magnitude will be that
of the forward window and the phase will be the previous output phase
plus the phase difference between the two analysis windows -- except
that if "lock" is on \, they will be modified to agree progressively
better with the inter-channel phase relationships of the input.;
#X text 284 268 If "lock" is on \, encourage neighboring channels to
stay in phase by adding the two neighboring complex amplitudes. The
result will tend toward the channel with the strongest amplitude. If
the phase relationships between channels in the output and those in
the input are in parallel \, then neighboring channels of the quotient
will all have the same phase and this will not change any phases. (lrshift
shifts the signal to the left or right depending on its argument.)
;
#X text 294 152 Read two windows \, one 1/4 length behind the other
\, of the input sound \, with Hann window function (see inside).;
#X obj 133 618 r \$0-window-size;
#X obj 109 133 inlet~;
#X obj 238 398 inlet~;
#X obj 210 310 sig~;
#X obj 209 284 r \$0-lock;
#X obj 71 590 tabreceive~ \$0-hann;
#X obj 133 541 tabsend~ \$0-prev-imagb;
#X obj 136 567 tabsend~ \$0-prev-realb;
#X obj 20 8 tabreceive~ \$0-prev-realb;
#X obj 74 29 tabreceive~ \$0-prev-imagb;
#X connect 0 0 2 1;
#X connect 1 0 2 0;
#X connect 2 0 15 0;
#X connect 2 0 55 0;
#X connect 3 0 5 1;
#X connect 4 0 5 0;
#X connect 5 0 15 1;
#X connect 5 0 54 0;
#X connect 6 0 19 1;
#X connect 7 0 19 0;
#X connect 8 0 10 1;
#X connect 9 0 10 0;
#X connect 10 0 35 0;
#X connect 10 0 34 0;
#X connect 10 0 40 0;
#X connect 11 0 18 1;
#X connect 12 0 16 0;
#X connect 13 0 1 1;
#X connect 13 0 3 1;
#X connect 13 1 0 1;
#X connect 13 1 4 1;
#X connect 14 0 9 1;
#X connect 14 0 7 1;
#X connect 14 1 6 1;
#X connect 14 1 8 1;
#X connect 15 0 23 0;
#X connect 17 0 18 0;
#X connect 18 0 25 0;
#X connect 19 0 36 0;
#X connect 19 0 37 0;
#X connect 19 0 41 0;
#X connect 20 0 1 0;
#X connect 20 0 4 0;
#X connect 21 0 0 0;
#X connect 21 0 3 0;
#X connect 22 0 17 1;
#X connect 22 0 17 0;
#X connect 22 0 20 0;
#X connect 23 0 12 0;
#X connect 24 0 12 1;
#X connect 25 0 20 1;
#X connect 25 0 21 1;
#X connect 27 0 29 1;
#X connect 28 0 29 0;
#X connect 29 0 31 0;
#X connect 30 0 32 1;
#X connect 30 0 33 1;
#X connect 31 0 30 0;
#X connect 32 0 8 0;
#X connect 32 0 7 0;
#X connect 33 0 9 0;
#X connect 33 0 6 0;
#X connect 34 0 38 0;
#X connect 35 0 38 0;
#X connect 36 0 39 0;
#X connect 37 0 39 0;
#X connect 38 0 40 1;
#X connect 39 0 41 1;
#X connect 40 0 22 0;
#X connect 41 0 11 0;
#X connect 41 0 11 1;
#X connect 41 0 21 0;
#X connect 48 0 24 0;
#X connect 49 0 14 0;
#X connect 50 0 13 0;
#X connect 51 0 39 1;
#X connect 51 0 38 1;
#X connect 52 0 51 0;
#X connect 53 0 23 1;
#X connect 56 0 28 1;
#X connect 56 0 28 0;
#X connect 56 0 33 0;
#X connect 57 0 27 1;
#X connect 57 0 27 0;
#X connect 57 0 32 0;
#X restore 169 541 pd fft-analysis;
#X obj 64 497 *~;
#X obj 241 499 *~;
#X obj 170 566 outlet~;
#X connect 0 0 24 0;
#X connect 1 0 24 1;
#X connect 2 0 49 0;
#X connect 3 0 15 1;
#X connect 4 0 15 0;
#X connect 4 1 3 0;
#X connect 5 0 27 0;
#X connect 6 0 12 1;
#X connect 7 0 9 0;
#X connect 7 0 3 1;
#X connect 7 0 6 0;
#X connect 8 0 7 0;
#X connect 8 1 7 1;
#X connect 9 0 10 1;
#X connect 10 0 4 0;
#X connect 12 0 51 0;
#X connect 12 0 59 0;
#X connect 14 0 15 2;
#X connect 15 0 5 0;
#X connect 17 0 8 0;
#X connect 18 0 14 0;
#X connect 20 0 19 0;
#X connect 23 0 20 0;
#X connect 24 0 25 0;
#X connect 27 0 12 0;
#X connect 27 0 52 0;
#X connect 27 0 60 0;
#X connect 28 0 56 0;
#X connect 29 0 39 0;
#X connect 29 1 30 0;
#X connect 30 0 31 0;
#X connect 33 0 34 0;
#X connect 33 0 37 0;
#X connect 34 0 33 1;
#X connect 35 0 33 0;
#X connect 36 0 33 1;
#X connect 37 0 42 0;
#X connect 37 1 38 0;
#X connect 38 0 45 0;
#X connect 39 0 35 0;
#X connect 39 1 36 0;
#X connect 39 2 38 1;
#X connect 40 0 41 0;
#X connect 41 0 46 0;
#X connect 42 0 43 0;
#X connect 44 0 40 0;
#X connect 45 0 44 0;
#X connect 46 0 47 0;
#X connect 47 0 42 1;
#X connect 48 0 26 0;
#X connect 49 0 10 0;
#X connect 50 0 49 0;
#X connect 51 0 0 0;
#X connect 52 0 1 0;
#X connect 53 0 7 0;
#X connect 54 0 48 0;
#X connect 55 0 0 1;
#X connect 55 0 1 1;
#X connect 55 0 64 1;
#X connect 55 0 65 1;
#X connect 56 0 29 0;
#X connect 59 0 64 0;
#X connect 60 0 65 0;
#X connect 63 0 66 0;
#X connect 64 0 63 0;
#X connect 65 0 63 1;
#X restore 58 107 pd fft;
#N canvas 427 179 332 645 read-point-generation 0;
#X obj 32 126 metro 10;
#X obj 34 173 f;
#X obj 35 197 t f f;
#X msg 33 97 1;
#X obj 144 133 * 441;
#X obj 86 177 + 441;
#X msg 45 267 \$1 \, \$2 10;
#X obj 47 291 vline~;
#X obj 47 314 outlet~;
#X obj 44 234 pack 0 0;
#X obj 29 11 r \$0-newpos;
#X obj 141 114 r \$0-speed;
#X obj 30 41 pipe 5;
#X obj 114 296 line;
#X obj 181 237 r \$0-durational;
#X obj 159 268 +;
#X obj 31 65 t b f f;
#X obj 128 328 <;
#X obj 128 395 outlet~;
#X obj 137 183 - 200;
#X obj 127 349 pack 0 5;
#X obj 129 374 vline~;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
#X connect 2 0 9 0;
#X connect 2 1 5 0;
#X connect 3 0 0 0;
#X connect 4 0 5 1;
#X connect 5 0 1 1;
#X connect 5 0 9 1;
#X connect 6 0 7 0;
#X connect 6 0 13 0;
#X connect 7 0 8 0;
#X connect 9 0 6 0;
#X connect 10 0 12 0;
#X connect 11 0 4 0;
#X connect 12 0 16 0;
#X connect 13 0 17 0;
#X connect 14 0 15 1;
#X connect 15 0 17 1;
#X connect 16 0 3 0;
#X connect 16 1 1 1;
#X connect 16 2 19 0;
#X connect 17 0 20 0;
#X connect 19 0 15 0;
#X connect 20 0 21 0;
#X connect 21 0 18 0;
#X restore 57 81 pd read-point-generation;
#X obj 58 239 *~;
#X obj 134 191 vline~;
#X msg 132 163 0 5 \, 1 5;
#X obj 134 122 r \$0-pos;
#X obj 136 144 t b;
#X obj 58 265 *~;
#X obj 146 239 *~;
#X obj 146 267 *~;
#X obj 145 296 outlet~;
#X obj 388 147 soundfiler;
#X obj 388 100 pack s f;
#X obj 441 74 f \$0;
#X obj 441 55 loadbang;
#X obj 388 170 s \$0-samplelength;
#X msg 388 124 read -resize \$1 \$2-sampleL \$2-sampleR;
#X obj 384 196 table \$0-sampleL;
#X obj 385 215 table \$0-sampleR;
#X obj 893 331 r \$0-bpm;
#X obj 893 355 mtl/bpmToMs;
#X obj 893 381 * 4;
#X obj 893 406 / 1000;
#X obj 893 432 * 44100;
#X obj 893 481 /;
#X obj 842 303 r \$0-samplelength;
#X obj 893 507 s \$0-speed;
#X obj 893 458 t b f;
#X obj 388 30 inlet filename;
#X obj 57 292 outlet~;
#X obj 1006 36 loadbang;
#X obj 1372 36 inlet params;
#X obj 1372 82 print PARAM_NOTFOUND;
#X obj 1372 58 tof/param route;
#X obj 1372 107 b;
#X obj 1372 131 tof/param gui;
#X obj 1006 81 tof/param /position 0 /g slider 0 1;
#X obj 1006 59 tof/argument 4;
#X obj 1006 105 s \$0-pos;
#X obj 1006 131 loadbang;
#X obj 1006 154 tof/argument 5;
#X obj 1006 200 s \$0-duration;
#X obj 1007 228 loadbang;
#X obj 1007 297 s \$0-bpm;
#X obj 1007 251 tof/argument 6;
#X obj 1006 176 tof/param /duration 1 /g slider 0 1;
#X obj 1006 327 loadbang;
#X obj 1006 350 tof/argument 7;
#X obj 1005 372 tof/param /pitchpercent 100 /g slider 0 1000;
#X obj 1005 396 s \$0-pitchpercent;
#X obj 1007 424 loadbang;
#X obj 1007 447 tof/argument 8;
#X obj 1006 493 s \$0-window_size;
#X msg 703 338 bang;
#X obj 703 362 s \$0-reset;
#X obj 670 290 loadbang;
#X obj 671 413 s \$0-direction-r;
#X msg 671 386 0;
#X obj 671 309 t b b;
#X obj 1006 469 tof/param /window_size 2 /g tgl;
#X obj 1007 273 tof/param /bpm 100 /g slider 0 300;
#X connect 0 0 3 0;
#X connect 1 0 0 1;
#X connect 2 0 0 0;
#X connect 4 0 7 0;
#X connect 5 0 4 0;
#X connect 6 0 8 0;
#X connect 8 0 9 0;
#X connect 9 0 4 0;
#X connect 9 1 4 1;
#X connect 10 0 12 0;
#X connect 11 0 10 0;
#X connect 13 0 15 0;
#X connect 13 1 21 0;
#X connect 14 0 13 0;
#X connect 14 1 20 1;
#X connect 14 1 22 1;
#X connect 15 0 20 0;
#X connect 16 0 15 1;
#X connect 16 0 21 1;
#X connect 17 0 16 0;
#X connect 18 0 19 0;
#X connect 19 0 17 0;
#X connect 20 0 42 0;
#X connect 21 0 22 0;
#X connect 22 0 23 0;
#X connect 24 0 28 0;
#X connect 25 0 29 0;
#X connect 26 0 25 1;
#X connect 27 0 26 0;
#X connect 29 0 24 0;
#X connect 32 0 33 0;
#X connect 33 0 34 0;
#X connect 34 0 35 0;
#X connect 35 0 36 0;
#X connect 36 0 40 0;
#X connect 37 0 39 0;
#X connect 38 0 37 0;
#X connect 40 0 37 0;
#X connect 40 1 37 1;
#X connect 41 0 25 0;
#X connect 43 0 50 0;
#X connect 44 0 46 0;
#X connect 46 0 45 0;
#X connect 47 0 48 0;
#X connect 49 0 51 0;
#X connect 50 0 49 0;
#X connect 52 0 53 0;
#X connect 53 0 58 0;
#X connect 55 0 57 0;
#X connect 57 0 73 0;
#X connect 58 0 54 0;
#X connect 59 0 60 0;
#X connect 60 0 61 0;
#X connect 61 0 62 0;
#X connect 63 0 64 0;
#X connect 64 0 72 0;
#X connect 66 0 67 0;
#X connect 68 0 71 0;
#X connect 70 0 69 0;
#X connect 71 0 70 0;
#X connect 71 1 66 0;
#X connect 72 0 65 0;
#X connect 73 0 56 0;
#X coords 0 0 1 1 210 110 0;
